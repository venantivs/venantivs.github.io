<!doctype html><html lang=pt-BR><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><meta content="<p>Veja como utilizar, indexar, e evitar queries N+1 com os campos do tipo JSONB no Ruby on Rails.</p>
" name=description><title>Utilizando JSONB com Rails</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><style>body{--primary-color:#5871a2;--primary-pale-color:#5871a210;--text-color:#3c4043;--text-pale-color:#94969f;--bg-color:#fff;--highlight-mark-color:#5f75b035;--callout-note-color:#5871a2;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460}body.dark{--primary-color:#5d77ac;--primary-pale-color:#5d77ac20;--text-color:#9197a5;--text-pale-color:#747983;--bg-color:#202124;--highlight-mark-color:#5f75b035;--callout-note-color:#5d77ac;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460}body{--main-font:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:768px;--main-max-width:768px;--avatar-size:120px;--icon-size:20px;--homepage-font-size:16px;--homepage-line-height:1.75;--paragraph-font-size:16px;--paragraph-line-height:1.75;--aside-font-size:15px;--img-border-radius:0;--callout-border-radius:0;--detail-border-radius:0;--dark-mode-img-brightness:.75;--dark-mode-chart-brightness:.75;--inline-code-border-radius:2px;--inline-code-bg-color:var(--primary-pale-color);--block-code-border-radius:0;--block-code-border-color:var(--primary-color);--detail-border-color:var(--primary-color)}</style><link href=/main.css rel=stylesheet><link href=/hl-light.css id=hl rel=stylesheet><script data-website-id=f1085119-2aa7-4146-9693-8b78bb885fd2 defer src=https://analytics.us.umami.is/script.js></script><body class=post><script>const theme=sessionStorage.getItem('theme');const match=window.matchMedia("(prefers-color-scheme: dark)").matches;if(theme&&theme=='dark'||!theme&&match){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a class=instant href=/>venantivs</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a class=instant href=/blog>blog</a><span class="wrap-separator fold">,</span><a class="instant fold" href=/about>about</a><span class="wrap right fold">} ;</span></nav><div id=btns><a aria-label="rss feed" href=/rss.xml id=rss-btn><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M3 17C5.20914 17 7 18.7909 7 21H3V17ZM3 10C9.07513 10 14 14.9249 14 21H12C12 16.0294 7.97056 12 3 12V10ZM3 3C12.9411 3 21 11.0589 21 21H19C19 12.1634 11.8366 5 3 5V3Z" fill=currentColor></path></svg></a><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><dialog id=rss-mask><div><a href=https://venantivs.com/rss.xml>https://venantivs.com/rss.xml</a><button data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' aria-label=copy autofocus data-link=https://venantivs.com/rss.xml><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill=currentColor></path></svg></button></div></dialog><div id=wrapper><div id=blank></div><aside><nav><ul><li><a class=h2 href=#introducao>Introdução</a><li><a class=h2 href=#json-vs-jsonb>JSON vs JSONB</a> <ul><li><a class=h3 href=#em-que-situacao-usar-json-inves-de-jsonb>Em que situação usar JSON invés de JSONB?</a></ul><li><a class=h2 href=#operadores>Operadores</a> <ul><li><a class=h3 href=#operadores-json-e-jsonb>Operadores JSON e JSONB</a><li><a class=h3 href=#operadores-apenas-jsonb>Operadores apenas JSONB</a></ul><li><a class=h2 href=#jsonb-no-rails>JSONB no Rails</a> <ul><li><a class=h3 href=#adicionando-um-campo-jsonb>Adicionando um campo JSONB</a><li><a class=h3 href=#criando-registros-com-json>Criando registros com JSON</a><li><a class=h3 href=#alterando-registros>Alterando registros</a><li><a class=h3 href=#alterando-registros-em-massa>Alterando registros em massa</a><li><a class=h3 href=#realizando-queries>Realizando queries</a></ul><li><a class=h2 href=#performance>Performance</a> <ul><li><a class=h3 href=#indexando-campos-jsonb>Indexando campos JSONB</a><li><a class=h3 href=#criando-um-indice-gin-no-rails>Criando um índice GIN no Rails</a><li><a class=h3 href=#criando-um-indice-de-expressao-b-tree>Criando um índice de expressão B-TREE</a><li><a class=h3 href=#comparando-resultados>Comparando resultados</a></ul><li><a class=h2 href=#conclusao>Conclusão</a></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Utilizando JSONB com Rails</h1><div id=post-info><div id=date><span id=publish>2024-05-12</span></div><div id=tags><a class=instant href=https://venantivs.com/tags/ruby><span>#</span>ruby</a><a class=instant href=https://venantivs.com/tags/rails><span>#</span>rails</a><a class=instant href=https://venantivs.com/tags/postgres><span>#</span>postgres</a><a class=instant href=https://venantivs.com/tags/jsonb><span>#</span>jsonb</a></div></div><span id=continue-reading></span><h2 id=introducao>Introdução<a aria-label="Anchor link for: introducao" class=zola-anchor href=#introducao style=visibility:hidden>#</a></h2><p>Às vezes, precisamos guardar o retorno de uma API, <em>logs</em>, ou simplesmente queremos guardar dados no Postgres de uma forma mais maleável, sem precisar apelar para alterações no <em>schema</em> da tabela quando um atributo novo precisar ser inserido ou removido. Para isso, o Postgres nos fornece os tipos <code>JSON</code> e <code>JSONB</code>, que iremos falar especialmente sobre o segundo no decorrer deste <em>post</em>.<blockquote class="callout note"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill=currentColor></path></svg></div><div class=content><p><strong>Nota</strong><p>Enquanto eu escrevia este <em>post</em>, acabei me deparando com outro, também em português sobre exatamente o mesmo assunto: <a rel="nofollow noreferrer" href=https://nandovieira.com.br/usando-postgresql-e-jsonb-no-rails>Blog do Nando Vieira</a>.</div></blockquote><h2 id=json-vs-jsonb>JSON vs JSONB<a aria-label="Anchor link for: json-vs-jsonb" class=zola-anchor href=#json-vs-jsonb style=visibility:hidden>#</a></h2><p>Se você deseja guardar objetos <em>json</em> no Postgres, basicamente você tem duas opções: JSON e JSONB, introduzidos nas versões 9.2 e 9.4 do Postgres, respectivamente. A diferença mais relevante entre ambas é que o tipo JSONB pode ser indexado, o que pra quem lida com uma quantidade razoável de dados pode fazer MUITA diferença.<p>Outras diferenças menores incluem que o tipo JSON, na inserção, insere os dados exatamente como foram fornecidos, não fazendo qualquer tipo de conversão. A consequência disto é que a ordem das chaves dentro dos objetos, chaves repetidas, e espaços em branco sintaticamente irrelevantes (espaço entre a chave e o <code>:</code>, por exemplo) serão mantidos. Porém, apesar disto significar um tempo de inserção menor, a conversão que não foi preciso ser feita na inserção precisará ser feita em qualquer outra operação necessária sobre o campo (incluindo projeção), o que também significará um tempo maior de processamento. O JSONB, por outro lado, logo na inserção é feita sua conversão para uma estrutura binária, que não precisará de conversão em outras operações, tornando-a mais performática para esses casos.<p>Um outro ponto que deve ser levado em consideração é que o campo JSONB possui mais operadores que o campo JSON.<p>Mais informações <a rel="nofollow noreferrer" href=https://www.postgresql.org/docs/current/datatype-json.html>aqui</a>.<h3 id=em-que-situacao-usar-json-inves-de-jsonb>Em que situação usar JSON invés de JSONB?<a aria-label="Anchor link for: em-que-situacao-usar-json-inves-de-jsonb" class=zola-anchor href=#em-que-situacao-usar-json-inves-de-jsonb style=visibility:hidden>#</a></h3><p>A menos que a ordem das chaves dentro dos objetos importe para seu uso, ou que você raramente irá utilizar qualquer operação sobre o campo que não seja inserção, como <em>logs</em> por exemplo, minha opinião é que não há motivos para usar o tipo JSON. Ainda assim, a não ser que seu requisito seja manter a ordem das chaves, JSONB pode funcionar muito bem nos outros cenários também.<h2 id=operadores>Operadores<a aria-label="Anchor link for: operadores" class=zola-anchor href=#operadores style=visibility:hidden>#</a></h2><p>Antes de irmos para o código, é importante aprender e entender a sintaxe que torna as operações com <em>json</em> possíveis no Postgres.<h3 id=operadores-json-e-jsonb>Operadores JSON e JSONB<a aria-label="Anchor link for: operadores-json-e-jsonb" class=zola-anchor href=#operadores-json-e-jsonb style=visibility:hidden>#</a></h3><p>Os operadores a seguir estão disponíveis tanto para JSON quanto para JSONB e provavelmente são os mais comuns e mais utilizados, pois são utilizados para fazer pesquisas.<p>O importante aqui é entender que a estrutura é sempre um JSON/JSONB, provavelmente a coluna da tabela, com <code>-></code>, e depois vem um texto ou número inteiro. Caso seja um texto, é extraído o elemento cuja chave é o texto. Caso seja um inteiro, é extraído o elemento que se encontra no índice representado pelo inteiro. No caso do operador <code>#></code>, à direita do operador colocamos um texto com um caminho a ser acessado no <em>json</em> (e.g. <code>{a,b}</code>). Ainda, pode ser adicionado mais um <code>></code> ao operador (e.g. <code>->></code> ou <code>#>></code>) fazendo com que o retorno seja texto, ao invés do tipo do operador à esquerda (JSON ou JSONB).<table><thead><tr><th>Operador<th>Descrição<tbody><tr><td>jsonb ->[>] text | integer<td>Extrai o elemento na posição "integer" ou com chave "text".<tr><td>jsonb #>[>] text[]<td>Extrai o elemento no caminho especificado.</table><p>Outra característica importante é que utilizando o primeiro operador com retorno JSON/JSONB (<code>-></code>), ele é encadeável. Isto é, em caso de um objeto <em>json</em> de vários níveis, você poderia fazer, por exemplo:<pre class=z-code><code><span class="z-text z-plain">'{"a": {"b": "olá" }}'::jsonb -> a ->> b → "olá"
</span></code></pre><p>Ou, obtendo o mesmo resultado utilizando <code>#>></code> especificando o caminho:<pre class=z-code><code><span class="z-text z-plain">'{"a": {"b": "olá" }}'::jsonb #>> '{a,b}' → "olá"
</span></code></pre><h3 id=operadores-apenas-jsonb>Operadores apenas JSONB<a aria-label="Anchor link for: operadores-apenas-jsonb" class=zola-anchor href=#operadores-apenas-jsonb style=visibility:hidden>#</a></h3><p>Apenas para JSONB, há uma lista maior de operadores, que não irei cobrir inteira aqui (apesar de aparecem nos exemplos) para que este <em>post</em> não fique maior do que já está. A lista completa pode ser acessada <a rel="nofollow noreferrer" href=https://www.postgresql.org/docs/16/functions-json.html#FUNCTIONS-JSONB-OP-TABLE>aqui</a>. Entretanto, falaremos de dois operadores específicos do JSONB que são importantes para pesquisas em objetos JSON: <code>@></code> (ou <code><@</code>) e <code>?</code>.<table><thead><tr><th>Operador<th>Descrição<tbody><tr><td>jsonb @> jsonb<td>Checa se json à esquerda contém o da direita.<tr><td>jsonb ? text<td>Checa se o elemento "text" existe (no nível mais raso).</table><h2 id=jsonb-no-rails>JSONB no Rails<a aria-label="Anchor link for: jsonb-no-rails" class=zola-anchor href=#jsonb-no-rails style=visibility:hidden>#</a></h2><blockquote class="callout warning"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12.865 3.00017L22.3912 19.5002C22.6674 19.9785 22.5035 20.5901 22.0252 20.8662C21.8732 20.954 21.7008 21.0002 21.5252 21.0002H2.47266C1.92037 21.0002 1.47266 20.5525 1.47266 20.0002C1.47266 19.8246 1.51886 19.6522 1.60663 19.5002L11.1329 3.00017C11.4091 2.52187 12.0206 2.358 12.4989 2.63414C12.651 2.72191 12.7772 2.84815 12.865 3.00017ZM4.20471 19.0002H19.7932L11.9989 5.50017L4.20471 19.0002ZM10.9989 16.0002H12.9989V18.0002H10.9989V16.0002ZM10.9989 9.00017H12.9989V14.0002H10.9989V9.00017Z" fill=currentColor></path></svg></div><div class=content><p><strong>Atenção</strong><p>O suporte para JSONB no Rails foi adicionado na versão 4.2</div></blockquote><h3 id=adicionando-um-campo-jsonb>Adicionando um campo JSONB<a aria-label="Anchor link for: adicionando-um-campo-jsonb" class=zola-anchor href=#adicionando-um-campo-jsonb style=visibility:hidden>#</a></h3><p>Para adicionar um campo JSONB ao criar uma tabela no Rails, basta colocar na <em>migration</em>:<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby">create_table <span class="z-constant z-other z-symbol z-ruby"><span class="z-punctuation z-definition z-constant z-ruby">:</span>events</span> <span class="z-keyword z-control z-start-block z-ruby">do</span> <span class="z-meta z-block z-parameters z-ruby"><span class="z-punctuation z-definition z-parameters z-begin z-ruby">|</span></span><span class="z-meta z-block z-parameters z-ruby"><span class="z-variable z-parameter z-ruby">t</span><span class="z-meta z-block z-parameters z-ruby"><span class="z-punctuation z-definition z-parameters z-end z-ruby">|</span></span></span>
</span><span class="z-source z-ruby">  <span class="z-comment z-line z-number-sign z-ruby"><span class="z-punctuation z-definition z-comment z-ruby">#</span> ...
</span></span><span class="z-source z-ruby">  t<span class="z-punctuation z-accessor z-dot z-ruby">.</span>jsonb <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>payload<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span>
</span><span class="z-source z-ruby">  <span class="z-comment z-line z-number-sign z-ruby"><span class="z-punctuation z-definition z-comment z-ruby">#</span> ...
</span></span><span class="z-source z-ruby"><span class="z-keyword z-control z-ruby">end</span>
</span></code></pre><p>Ou, para adicionar em uma tabela já existente:<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-meta z-function z-ruby"><span class="z-keyword z-control z-def z-ruby">def</span></span><span class="z-meta z-function z-ruby"> <span class="z-entity z-name z-function z-ruby">change</span></span>
</span><span class="z-source z-ruby">  add_column <span class="z-constant z-other z-symbol z-ruby"><span class="z-punctuation z-definition z-constant z-ruby">:</span>events</span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-constant z-other z-symbol z-ruby"><span class="z-punctuation z-definition z-constant z-ruby">:</span>payload</span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-constant z-other z-symbol z-ruby"><span class="z-punctuation z-definition z-constant z-ruby">:</span>jsonb</span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-constant z-other z-symbol z-ruby">default<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-punctuation z-section z-scope z-ruby">{</span><span class="z-punctuation z-section z-scope z-ruby">}</span>
</span><span class="z-source z-ruby"><span class="z-keyword z-control z-ruby">end</span>
</span></code></pre><p>O parâmetro <code>default</code> é opcional, assim como em outros tipos.<h3 id=criando-registros-com-json>Criando registros com JSON<a aria-label="Anchor link for: criando-registros-com-json" class=zola-anchor href=#criando-registros-com-json style=visibility:hidden>#</a></h3><p>Para criar um registro em um modelo que possua um atributo com JSONB (ou JSON), basta passar o campo como Hash, que o próprio ActiveRecord irá fazer a conversão:<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>create!<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span>
</span><span class="z-source z-ruby">  <span class="z-comment z-line z-number-sign z-ruby"><span class="z-punctuation z-definition z-comment z-ruby">#</span> ...
</span></span><span class="z-source z-ruby">  <span class="z-constant z-other z-symbol z-ruby">payload<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-punctuation z-section z-scope z-ruby">{</span>
</span><span class="z-source z-ruby">    <span class="z-constant z-other z-symbol z-ruby">a<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-punctuation z-section z-scope z-ruby">{</span>
</span><span class="z-source z-ruby">      <span class="z-constant z-other z-symbol z-ruby">b<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-punctuation z-section z-scope z-ruby">{</span>
</span><span class="z-source z-ruby">        <span class="z-constant z-other z-symbol z-ruby">c<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>fizz<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span>
</span><span class="z-source z-ruby">      <span class="z-punctuation z-section z-scope z-ruby">}</span>
</span><span class="z-source z-ruby">    <span class="z-punctuation z-section z-scope z-ruby">}</span><span class="z-punctuation z-separator z-sequence z-ruby">,</span>
</span><span class="z-source z-ruby">    <span class="z-constant z-other z-symbol z-ruby">foo<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>bar<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-separator z-sequence z-ruby">,</span>
</span><span class="z-source z-ruby">    <span class="z-constant z-other z-symbol z-ruby">array<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-punctuation z-section z-array z-ruby">[</span><span class="z-constant z-numeric z-integer z-decimal z-ruby">1</span><span class="z-punctuation z-separator z-sequence z-ruby">,</span><span class="z-constant z-numeric z-integer z-decimal z-ruby">2</span><span class="z-punctuation z-separator z-sequence z-ruby">,</span><span class="z-constant z-numeric z-integer z-decimal z-ruby">3</span><span class="z-punctuation z-separator z-sequence z-ruby">,</span><span class="z-constant z-numeric z-integer z-decimal z-ruby">4</span><span class="z-punctuation z-section z-array z-ruby">]</span>
</span><span class="z-source z-ruby">  <span class="z-punctuation z-section z-scope z-ruby">}</span>
</span><span class="z-source z-ruby">  <span class="z-comment z-line z-number-sign z-ruby"><span class="z-punctuation z-definition z-comment z-ruby">#</span> ...
</span></span><span class="z-source z-ruby"><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><p>Uma vez criado, para acessar o campo, o ActiveRecord também converte o objeto <em>json</em> em <em>hash</em>:<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby">event <span class="z-keyword z-operator z-assignment z-ruby">=</span> <span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>last<span class="z-punctuation z-accessor z-dot z-ruby">.</span>payload
</span><span class="z-source z-ruby"><span class="z-comment z-line z-number-sign z-ruby"><span class="z-punctuation z-definition z-comment z-ruby">#</span> => {"a"=>{"b"=>{"c"=>"fizz"}}, "foo"=>"bar", "array"=>[1,2,3,4]}
</span></span></code></pre><p>Algo a ser notado aqui, é que apesar de termos passado uma <em>hash</em> com as chaves como símbolos, o retorno sempre será feito com as chaves em <em>string</em>, assim como manda a <a rel="nofollow noreferrer" href=https://datatracker.ietf.org/doc/html/rfc7159#section-4>especificação do JSON</a>:<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby">event <span class="z-keyword z-operator z-assignment z-ruby">=</span> <span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>last
</span><span class="z-source z-ruby">
</span><span class="z-source z-ruby">event<span class="z-punctuation z-accessor z-dot z-ruby">.</span>payload<span class="z-punctuation z-section z-array z-ruby">[</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>foo<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span><span class="z-punctuation z-section z-array z-ruby">]</span>
</span><span class="z-source z-ruby"><span class="z-comment z-line z-number-sign z-ruby"><span class="z-punctuation z-definition z-comment z-ruby">#</span> => "bar"
</span></span><span class="z-source z-ruby">
</span><span class="z-source z-ruby">event<span class="z-punctuation z-accessor z-dot z-ruby">.</span>payload<span class="z-punctuation z-section z-array z-ruby">[</span><span class="z-constant z-other z-symbol z-ruby"><span class="z-punctuation z-definition z-constant z-ruby">:</span>foo</span><span class="z-punctuation z-section z-array z-ruby">]</span>
</span><span class="z-source z-ruby"><span class="z-comment z-line z-number-sign z-ruby"><span class="z-punctuation z-definition z-comment z-ruby">#</span> => nil
</span></span></code></pre><p>Caso prefira, como o campo no Rails se tornará uma <em>hash</em>, nada te impede de utilizar métodos como <code>deep_symbolize_keys</code> ou <code>with_indifferent_access</code> para acessar os objetos utilizando símbolos. Apenas tenha em mente que terá de fazer isto toda vez que um registro for carregado do banco.<p>Outro ponto de atenção é que você deve ter cuidado com quais tipos de dados você passa na Hash que será convertida em <em>json</em>. Cada chave deve conter ou outra <em>hash</em>, ou um <em>array</em>, um número ou uma <em>string</em>. Qualquer coisa fora disso será convertida em <em>string</em> e quando voltar ao Ruby, será mantida como <em>string</em>. Em casos de objetos Ruby, estes serão serializados. Exemplo:<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-meta z-class z-ruby"><span class="z-keyword z-control z-class z-ruby">class</span></span><span class="z-meta z-class z-ruby"> </span><span class="z-meta z-class z-ruby"><span class="z-entity z-name z-class z-ruby">Thing</span></span><span class="z-meta z-class z-ruby">
</span></span><span class="z-source z-ruby"><span class="z-meta z-class z-ruby">  </span><span class="z-meta z-function z-ruby"><span class="z-keyword z-control z-def z-ruby">def</span></span><span class="z-meta z-function z-ruby"> <span class="z-entity z-name z-function z-ruby">initialize</span></span><span class="z-meta z-function z-parameters z-ruby"><span class="z-punctuation z-definition z-group z-begin z-ruby">(</span></span><span class="z-meta z-function z-parameters z-ruby"><span class="z-variable z-parameter z-ruby">a</span><span class="z-punctuation z-separator z-ruby">,</span> <span class="z-variable z-parameter z-ruby">b</span></span><span class="z-meta z-function z-parameters z-ruby"><span class="z-punctuation z-definition z-group z-end z-ruby">)</span></span>
</span><span class="z-source z-ruby">    <span class="z-variable z-other z-readwrite z-instance z-ruby"><span class="z-punctuation z-definition z-variable z-ruby">@</span>a</span> <span class="z-keyword z-operator z-assignment z-ruby">=</span> a
</span><span class="z-source z-ruby">    <span class="z-variable z-other z-readwrite z-instance z-ruby"><span class="z-punctuation z-definition z-variable z-ruby">@</span>b</span> <span class="z-keyword z-operator z-assignment z-ruby">=</span> b
</span><span class="z-source z-ruby">  <span class="z-keyword z-control z-ruby">end</span>
</span><span class="z-source z-ruby"><span class="z-keyword z-control z-ruby">end</span>
</span><span class="z-source z-ruby">
</span><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>create!<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-punctuation z-section z-scope z-ruby">{</span>
</span><span class="z-source z-ruby">  <span class="z-constant z-other z-symbol z-ruby">payload<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-punctuation z-section z-scope z-ruby">{</span>
</span><span class="z-source z-ruby">    <span class="z-constant z-other z-symbol z-ruby">current_time<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-support z-class z-ruby">Time</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>current
</span><span class="z-source z-ruby">    <span class="z-constant z-other z-symbol z-ruby">thing<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-support z-class z-ruby">Thing</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span><span class="z-keyword z-other z-special-method z-ruby">new</span><span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-constant z-numeric z-integer z-decimal z-ruby">1</span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-constant z-numeric z-integer z-decimal z-ruby">2</span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span><span class="z-source z-ruby">  <span class="z-punctuation z-section z-scope z-ruby">}</span>
</span><span class="z-source z-ruby"><span class="z-punctuation z-section z-scope z-ruby">}</span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span><span class="z-source z-ruby">
</span><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>last<span class="z-punctuation z-accessor z-dot z-ruby">.</span>payload<span class="z-punctuation z-section z-array z-ruby">[</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>current_time<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span><span class="z-punctuation z-section z-array z-ruby">]</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span><span class="z-support z-function z-builtin z-ruby">class</span>
</span><span class="z-source z-ruby"><span class="z-comment z-line z-number-sign z-ruby"><span class="z-punctuation z-definition z-comment z-ruby">#</span> => String
</span></span><span class="z-source z-ruby">
</span><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>last<span class="z-punctuation z-accessor z-dot z-ruby">.</span>payload<span class="z-punctuation z-section z-array z-ruby">[</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>thing<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span><span class="z-punctuation z-section z-array z-ruby">]</span>
</span><span class="z-source z-ruby"><span class="z-comment z-line z-number-sign z-ruby"><span class="z-punctuation z-definition z-comment z-ruby">#</span> => {"a" => 1, "b" => 2}
</span></span></code></pre><h3 id=alterando-registros>Alterando registros<a aria-label="Anchor link for: alterando-registros" class=zola-anchor href=#alterando-registros style=visibility:hidden>#</a></h3><p>Para alterar registros com campo JSONB, basta alterar a Hash e mandar salvar o registro:<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby">event <span class="z-keyword z-operator z-assignment z-ruby">=</span> <span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>last
</span><span class="z-source z-ruby">
</span><span class="z-source z-ruby">event<span class="z-punctuation z-accessor z-dot z-ruby">.</span>payload<span class="z-punctuation z-section z-array z-ruby">[</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>foo<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span><span class="z-punctuation z-section z-array z-ruby">]</span> <span class="z-keyword z-operator z-assignment z-ruby">=</span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>baz<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span>
</span><span class="z-source z-ruby">
</span><span class="z-source z-ruby">event<span class="z-punctuation z-accessor z-dot z-ruby">.</span>save!
</span></code></pre><p>ou, utilizando o método <code>update</code>:<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby">event <span class="z-keyword z-operator z-assignment z-ruby">=</span> <span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>last
</span><span class="z-source z-ruby">
</span><span class="z-source z-ruby">new_payload <span class="z-keyword z-operator z-assignment z-ruby">=</span> event<span class="z-punctuation z-accessor z-dot z-ruby">.</span>payload<span class="z-punctuation z-accessor z-dot z-ruby">.</span>merge<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-punctuation z-section z-scope z-ruby">{</span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>foo<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span> <span class="z-punctuation z-separator z-key-value z-ruby">=></span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>baz<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span> <span class="z-punctuation z-section z-scope z-ruby">}</span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span><span class="z-source z-ruby">
</span><span class="z-source z-ruby">event<span class="z-punctuation z-accessor z-dot z-ruby">.</span>update!<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-constant z-other z-symbol z-ruby">payload<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> new_payload<span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><p>A partir disso, como estamos alterando o campo inteiro, a partir da manipulação da <code>Hash</code> conseguimos fazer qualquer coisa: Adicionar ou remover chaves, alterar valores, etc.<h3 id=alterando-registros-em-massa>Alterando registros em massa<a aria-label="Anchor link for: alterando-registros-em-massa" class=zola-anchor href=#alterando-registros-em-massa style=visibility:hidden>#</a></h3><p>Se você é atento, reparou que na subseção anterior, de ambas as formas, acabamos por carregar o registro inteiro para a aplicação e substituímos todo o campo JSONB, mesmo que alteramos apenas um atributo. Apesar de funcionar, pode não ser o ideal em casos onde objeto <em>json</em> é muito grande ou seja necessário alterar vários registros de uma vez (criando uma situação de Query N+1).<h4 id=alterando-um-atributo>Alterando um atributo<a aria-label="Anchor link for: alterando-um-atributo" class=zola-anchor href=#alterando-um-atributo style=visibility:hidden>#</a></h4><p>Para alterar apenas um atributo, precisaremos utilizar uma função específica do Postgres, a <code>jsonb_set</code>.<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>where<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-keyword z-operator z-range z-ruby">...</span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>update_all<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>payload = jsonb_set(payload, '{foo}', to_jsonb('baz'::text))<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><h4 id=inserindo-um-novo-atributo>Inserindo um novo atributo<a aria-label="Anchor link for: inserindo-um-novo-atributo" class=zola-anchor href=#inserindo-um-novo-atributo style=visibility:hidden>#</a></h4><p>Na mesma linha, ao invés de atualizar um valor de um atributo, você pode também querer apenas adicionar um novo atributo junto com um valor. Para isso existe a função <code>jsonb_insert</code>:<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>where<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-keyword z-operator z-range z-ruby">...</span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>update_all<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>payload = jsonb_insert(payload, '{hello}', to_jsonb('world'::text))<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><p>A função <code>jsonb_insert</code> também pode ser utilizada para inserir um elemento em um <em>array</em>:<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>where<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-keyword z-operator z-range z-ruby">...</span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>update_all<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>payload = jsonb_insert(payload, '{array, 0}', to_jsonb('new_value'::text))<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><p>No caso acima, estamos inserindo "new_value" na primeira posição do <em>array</em>.<h4 id=removendo-um-atributo>Removendo um atributo<a aria-label="Anchor link for: removendo-um-atributo" class=zola-anchor href=#removendo-um-atributo style=visibility:hidden>#</a></h4><p>Para remover um atributo junto com seu valor, podemos utilizar o operador <code>-</code> (cuidado ao utilizá-lo):<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>where<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-keyword z-operator z-range z-ruby">...</span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>update_all<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>payload = payload - 'foo'<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><h3 id=realizando-queries>Realizando queries<a aria-label="Anchor link for: realizando-queries" class=zola-anchor href=#realizando-queries style=visibility:hidden>#</a></h3><p>Até agora criamos e atualizamos registros. E para encontrar um registro específico dependendo de um ou mais atributos <em>json</em>? Aqui vão alguns casos comuns:<h4 id=retornar-registros-em-que-um-atributo-e-igual-a-um-valor>Retornar registros em que um atributo é igual a um valor<a aria-label="Anchor link for: retornar-registros-em-que-um-atributo-e-igual-a-um-valor" class=zola-anchor href=#retornar-registros-em-que-um-atributo-e-igual-a-um-valor style=visibility:hidden>#</a></h4><pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>where<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>payload->>'foo' = ?<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>bar<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><p>Ou utilizando o operador com retorno em jsonb:<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>where<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>payload->'foo' = ?<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>bar<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>to_json<span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><p>Podemos também utilizar o operador "contém":<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">User</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>where<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>payload @> ?<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-punctuation z-section z-scope z-ruby">{</span> <span class="z-constant z-other z-symbol z-ruby">foo<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>bar<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span> <span class="z-punctuation z-section z-scope z-ruby">}</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>to_json<span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><h4 id=retornar-registros-cujo-atributo-aninhado-e-igual-um-valor>Retornar registros cujo atributo aninhado é igual um valor<a aria-label="Anchor link for: retornar-registros-cujo-atributo-aninhado-e-igual-um-valor" class=zola-anchor href=#retornar-registros-cujo-atributo-aninhado-e-igual-um-valor style=visibility:hidden>#</a></h4><pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>where<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>payload->'a'->'b'->>'c' = ?<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>fizz<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><p>Ou utilizando o operador com caminho:<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>where<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>payload #>> '{a,b,c}' = ?<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>fizz<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><h4 id=retornar-registros-que-possuem-uma-chave-especifica-definida>Retornar registros que possuem uma chave específica definida<a aria-label="Anchor link for: retornar-registros-que-possuem-uma-chave-especifica-definida" class=zola-anchor href=#retornar-registros-que-possuem-uma-chave-especifica-definida style=visibility:hidden>#</a></h4><pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>where<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>payload ? :key<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-constant z-other z-symbol z-ruby">key<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>foo<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><p>Caso seja necessário checar se mais de uma chave existem ao mesmo tempo, podemos utilizar o operador <code>?&</code><pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>where<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>payload ?& array[:keys]<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-constant z-other z-symbol z-ruby">keys<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-punctuation z-section z-array z-ruby">[</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>foo<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>a<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span><span class="z-punctuation z-section z-array z-ruby">]</span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><p>Também há a possibilidade de, dado várias opções, retornar os registros que possuem pelo menos uma das chaves utilizando o operador <code>?|</code><pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>where<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>payload ?& array[:keys]<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-constant z-other z-symbol z-ruby">keys<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-punctuation z-section z-array z-ruby">[</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>foo<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>any_other_key<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span><span class="z-punctuation z-section z-array z-ruby">]</span><span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><h4 id=retornar-registros-que-contem-um-determinado-objeto>Retornar registros que contém um determinado objeto<a aria-label="Anchor link for: retornar-registros-que-contem-um-determinado-objeto" class=zola-anchor href=#retornar-registros-que-contem-um-determinado-objeto style=visibility:hidden>#</a></h4><pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">Event</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>where<span class="z-punctuation z-definition z-group z-begin z-ruby">(</span><span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>extradata @> ?<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-punctuation z-section z-scope z-ruby">{</span><span class="z-constant z-other z-symbol z-ruby">a<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-punctuation z-section z-scope z-ruby">{</span><span class="z-constant z-other z-symbol z-ruby">b<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-punctuation z-section z-scope z-ruby">{</span><span class="z-constant z-other z-symbol z-ruby">c<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>fizz<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-section z-scope z-ruby">}</span><span class="z-punctuation z-section z-scope z-ruby">}</span><span class="z-punctuation z-section z-scope z-ruby">}</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>to_json<span class="z-punctuation z-definition z-group z-end z-ruby">)</span>
</span></code></pre><h2 id=performance>Performance<a aria-label="Anchor link for: performance" class=zola-anchor href=#performance style=visibility:hidden>#</a></h2><blockquote class="callout note"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z" fill=currentColor></path></svg></div><div class=content><p><strong>Nota</strong><p>Os testes foram feitos utilizando Ruby 3.3.0, Rails 7.1.3.2 e Postgres 16.2</div></blockquote><p>A fim de tentar demonstrar melhor as diferenças entre JSON e JSONB, criei duas tabelas diferentes, ambas com 100.000 (cem mil) registros, cada uma com um objeto json simples (nome gerado a cada inserção pela <em>gem</em> <a rel="nofollow noreferrer" href=https://github.com/faker-ruby/faker>Faker</a>):<pre class="language-json z-code" data-lang=json><code class=language-json data-lang=json><span class="z-source z-json"><span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span>
</span></span><span class="z-source z-json"><span class="z-meta z-mapping z-json">  </span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>user<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span>
</span></span></span><span class="z-source z-json"><span class="z-meta z-mapping z-value z-json"><span class="z-meta z-mapping z-json">    </span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>name<span class="z-punctuation z-definition z-string z-end z-json">"</span></span></span><span class="z-meta z-mapping z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">"</span>RANDOMLY GENERATED<span class="z-punctuation z-definition z-string z-end z-json">"</span></span>
</span></span></span><span class="z-source z-json"><span class="z-meta z-mapping z-value z-json"><span class="z-meta z-mapping z-value z-json">  <span class="z-punctuation z-section z-mapping z-end z-json">}</span></span>
</span></span><span class="z-source z-json"><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-section z-mapping z-end z-json">}</span></span>
</span></code></pre><pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-support z-class z-ruby">EventsJson</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>count
</span><span class="z-source z-ruby"><span class="z-punctuation z-separator z-key-value z-ruby">=></span> <span class="z-constant z-numeric z-integer z-decimal z-ruby">100000</span>
</span><span class="z-source z-ruby"><span class="z-support z-class z-ruby">EventsJsonb</span><span class="z-punctuation z-accessor z-dot z-ruby">.</span>count
</span><span class="z-source z-ruby"><span class="z-punctuation z-separator z-key-value z-ruby">=></span> <span class="z-constant z-numeric z-integer z-decimal z-ruby">100000</span>
</span></code></pre><p>Comparando ambas, sem um índice no campo JSONB, pesquisando 1.000 vezes uma string estática inexistente:<pre class=z-code><code><span class="z-text z-plain">Rehearsal -----------------------------------------
</span><span class="z-text z-plain">json    0.249155   0.114169   0.363324 ( 66.338925)
</span><span class="z-text z-plain">jsonb   0.282361   0.028095   0.310456 ( 17.515571)
</span><span class="z-text z-plain">-------------------------------- total: 0.673780sec
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">            user     system      total        real
</span><span class="z-text z-plain">json    0.295434   0.061096   0.356530 ( 65.830411)
</span><span class="z-text z-plain">jsonb   0.243282   0.072838   0.316120 ( 17.484288)
</span></code></pre><p>Nota-se que o jsonb é consideravelmente mais rápido, em torno de 73%, o que pode ser atribuído ao fato do Postgres não precisar fazer a conversão do campo a cada operação. Porém, conforme o número de registros aumentar nestas duas tabelas, a chance é que essa diferença diminua com o tempo.<p>"Rodando" ambas as queries com EXPLAIN, é confirmado que ambas estão fazendo uma busca sequencial (Seq Scan):<p>JSON:<pre class=z-code><code><span class="z-text z-plain"># EXPLAIN SELECT * FROM events_jsons WHERE payload->'user'->>'name' = 'abcedefgh'
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">Seq Scan on events_jsons  (cost=0.00..2877.67 rows=500 width=59)
</span><span class="z-text z-plain">  Filter: (((payload -> 'user'::text) ->> 'name'::text) = 'abcdefgh'::text)
</span></code></pre><p>JSONB:<pre class=z-code><code><span class="z-text z-plain"># EXPLAIN SELECT * FROM events_jsonbs WHERE payload->'user'->>'name' = 'abcedefgh'
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">Seq Scan on events_jsonbs  (cost=0.00..3021.28 rows=500 width=71)
</span><span class="z-text z-plain">  Filter: (((payload -> 'user'::text) ->> 'name'::text) = 'abcdefgh'::text)
</span></code></pre><h3 id=indexando-campos-jsonb>Indexando campos JSONB<a aria-label="Anchor link for: indexando-campos-jsonb" class=zola-anchor href=#indexando-campos-jsonb style=visibility:hidden>#</a></h3><p>Para indexar campos JSONB, você basicamente tem 3 opções de tipos de índice: <code>b-tree</code>, <code>hash</code> ou <code>gin</code>.<h4 id=qual-tipo-de-indice-utilizar>Qual tipo de índice utilizar?<a aria-label="Anchor link for: qual-tipo-de-indice-utilizar" class=zola-anchor href=#qual-tipo-de-indice-utilizar style=visibility:hidden>#</a></h4><p>Caso você queira indexar o campo inteiro, sua melhor opção será o índice do tipo <code>gin</code>. Os tipos <code>b-tree</code> e <code>hash</code>, caso utilizados no campo inteiro, só são úteis para comparar o objeto json inteiro.<p>Ainda assim, o tipo <code>gin</code> possui suas limitações. A principal que deve ser levada em consideração é que caso for indexado o campo todo, os operadores padrão apenas irão utilizar o índice caso a condição da <em>query</em> esteja pesqusiando por atributos no nível "mais raso" do objeto <em>json</em>. Para driblar este problema, um índice de expressão deve ser criado ou deve ser feita a utilização do operador <code>@></code>, com o operando à direita devendo ser um objeto <em>json</em>. Outra limitação importante é que índices do tipo <code>gin</code> não suportam operadores como <code>=</code>, <code>></code>, <code>>=</code>, <code><</code>, <code><=</code>, etc. Caso você precise, por exemplo, checar se o valor em uma chave é maior que determinado outro, uma saída melhor é utilizar um índice de expressão do tipo <code>b-tree</code> no "caminho" desejado do objeto <em>json</em>.<p>Este pequeno trecho acima é a "ponta do <em>iceberg</em>" sobre indexação de campos JSONB. O importante aqui é não sair criando índices cegamente sem antes analisar qual será o perfil das <em>queries</em> feitas. Para mais informações e exemplos (em inglês): <a rel="nofollow noreferrer" href=https://www.postgresql.org/docs/current/datatype-json.html#JSON-INDEXING>Documentação do Postgres</a> ou <a rel="nofollow noreferrer" href=https://scalegrid.io/blog/using-jsonb-in-postgresql-how-to-effectively-store-index-json-data-in-postgresql/>este ótimo artigo</a>.<h3 id=criando-um-indice-gin-no-rails>Criando um índice GIN no Rails<a aria-label="Anchor link for: criando-um-indice-gin-no-rails" class=zola-anchor href=#criando-um-indice-gin-no-rails style=visibility:hidden>#</a></h3><p>Como o objeto json que criamos é aninhado, para que o índice seja utilizado ao buscarmos pelo nome do usuário, podemos tanto criar um índice <code>gin</code> no campo inteiro e utilizar o operador <code>@></code>, ou criar um índice de expressão (este podendo ser <code>b-tree</code> ou <code>gin</code>). Para começar, vamos indexar o campo inteiro utilizando o tipo <code>gin</code>:<pre class=z-code><code><span class="z-text z-plain">class AddIndexToEvents < ActiveRecord::Migration[7.1]
</span><span class="z-text z-plain">  def change
</span><span class="z-text z-plain">    add_index :events_jsonbs, :payload, using: :gin, name: 'index_events_jsonbs_on_payload'
</span><span class="z-text z-plain">  end
</span><span class="z-text z-plain">end
</span></code></pre><p>Agora, vamos rodar um <code>EXPLAIN</code> na nossa query novamente para ver se o índice está sendo utilizado:<pre class=z-code><code><span class="z-text z-plain"># EXPLAIN SELECT * FROM events_jsonbs WHERE payload->'user'->>'name' = 'abcedefgh'
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">Seq Scan on events_jsonbs  (cost=0.00..3021.00 rows=500 width=71)
</span><span class="z-text z-plain">  Filter: (((payload -> 'user'::text) ->> 'name'::text) = 'abcedefgh'::text)
</span></code></pre><p>E... Continuamos utilizando a busca sequencial. Como dito anteriormente, índices do tipo GIN não suportam operadores como <code>=</code>, então, precisamos trocar por <code>@></code>:<pre class=z-code><code><span class="z-text z-plain"># EXPLAIN SELECT * FROM events_jsonbs WHERE payload @> '{"user": {"name": "abcdefgh"}}'
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">Bitmap Heap Scan on events_jsonbs  (cost=43.06..80.53 rows=10 width=71)
</span><span class="z-text z-plain">  Recheck Cond: (payload @> '{"user": {"name": "abcdefgh"}}'::jsonb)
</span><span class="z-text z-plain">  ->  Bitmap Index Scan on index_events_jsonbs_on_payload  (cost=0.00..43.06 rows=10 width=0)
</span><span class="z-text z-plain">        Index Cond: (payload @> '{"user": {"name": "abcdefgh"}}'::jsonb)
</span></code></pre><p>Também foi dito que índices do tipo <code>gin</code> apenas indexam o nível mais raso (quando não utilizado um índice de expressão), então ainda usando o operador <code>@></code>, porém acessando um objeto mais aninhado, o índice também não funciona:<pre class=z-code><code><span class="z-text z-plain"># EXPLAIN SELECT * FROM events_jsonbs WHERE payload->'user' @> '{"name": "abcdefgh"}'
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">Seq Scan on events_jsonbs  (cost=0.00..2771.00 rows=1000 width=71)
</span><span class="z-text z-plain">  Filter: ((payload -> 'user'::text) @> '{"name": "abcdefgh"}'::jsonb)
</span></code></pre><h3 id=criando-um-indice-de-expressao-b-tree>Criando um índice de expressão B-TREE<a aria-label="Anchor link for: criando-um-indice-de-expressao-b-tree" class=zola-anchor href=#criando-um-indice-de-expressao-b-tree style=visibility:hidden>#</a></h3><p>Ainda considerando o caso onde queiramos buscar um usuário com nome "abcdefgh", como já dito anteriormente, em índices do tipo <code>b-tree</code> só será possível verificar isso com índices de expressão.<blockquote class="callout warning"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12.865 3.00017L22.3912 19.5002C22.6674 19.9785 22.5035 20.5901 22.0252 20.8662C21.8732 20.954 21.7008 21.0002 21.5252 21.0002H2.47266C1.92037 21.0002 1.47266 20.5525 1.47266 20.0002C1.47266 19.8246 1.51886 19.6522 1.60663 19.5002L11.1329 3.00017C11.4091 2.52187 12.0206 2.358 12.4989 2.63414C12.651 2.72191 12.7772 2.84815 12.865 3.00017ZM4.20471 19.0002H19.7932L11.9989 5.50017L4.20471 19.0002ZM10.9989 16.0002H12.9989V18.0002H10.9989V16.0002ZM10.9989 9.00017H12.9989V14.0002H10.9989V9.00017Z" fill=currentColor></path></svg></div><div class=content><p><strong>Atenção</strong><p>O suporte para índices de expressão foi adicionado na versão 5 do Rails, caso você esteja em uma versão anterior, terá de utilizar o método <code>execute</code> do <code>ActiveRecord::Migration</code>, invés do <code>add_index</code> padrão.</div></blockquote><p>Como índices do tipo <code>b-tree</code> são padrão, podemos omitir o atributo <code>using</code>:<pre class="language-ruby z-code" data-lang=ruby><code class=language-ruby data-lang=ruby><span class="z-source z-ruby"><span class="z-meta z-class z-ruby"><span class="z-keyword z-control z-class z-ruby">class</span></span><span class="z-meta z-class z-ruby"> </span><span class="z-meta z-class z-ruby"><span class="z-entity z-name z-class z-ruby">AddBTreeIndexToEvents</span></span><span class="z-meta z-class z-ruby"> <span class="z-punctuation z-separator z-inheritance z-ruby"><</span></span><span class="z-meta z-class z-ruby"> </span><span class="z-meta z-class z-ruby"><span class="z-entity z-other z-inherited-class z-ruby"><span class="z-support z-other z-namespace z-ruby">ActiveRecord</span><span class="z-punctuation z-accessor z-double-colon z-ruby">::</span>Migration</span></span><span class="z-punctuation z-section z-array z-ruby">[</span><span class="z-constant z-numeric z-float z-decimal z-ruby">7<span class="z-punctuation z-separator z-decimal z-ruby">.</span>1</span><span class="z-punctuation z-section z-array z-ruby">]</span>
</span><span class="z-source z-ruby">  <span class="z-meta z-function z-ruby"><span class="z-keyword z-control z-def z-ruby">def</span></span><span class="z-meta z-function z-ruby"> <span class="z-entity z-name z-function z-ruby">change</span></span>
</span><span class="z-source z-ruby">    add_index <span class="z-constant z-other z-symbol z-ruby"><span class="z-punctuation z-definition z-constant z-ruby">:</span>events_jsonbs</span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-double z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">"</span>(payload->'user'->>'name')<span class="z-punctuation z-definition z-string z-end z-ruby">"</span></span></span><span class="z-punctuation z-separator z-sequence z-ruby">,</span> <span class="z-constant z-other z-symbol z-ruby">name<span class="z-punctuation z-definition z-constant z-ruby">:</span></span> <span class="z-meta z-string z-ruby"><span class="z-string z-quoted z-single z-ruby"><span class="z-punctuation z-definition z-string z-begin z-ruby">'</span>index_events_jsonbs_on_payload_user_name<span class="z-punctuation z-definition z-string z-end z-ruby">'</span></span></span>
</span><span class="z-source z-ruby">  <span class="z-keyword z-control z-ruby">end</span>
</span><span class="z-source z-ruby"><span class="z-keyword z-control z-ruby">end</span>
</span></code></pre><p>Rodando a <em>query</em> novamente:<pre class=z-code><code><span class="z-text z-plain"># EXPLAIN SELECT * FROM events_jsonbs WHERE payload->'user'->>'name' = 'abcedefgh'
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">Bitmap Heap Scan on events_jsonbs  (cost=16.29..977.90 rows=500 width=71)
</span><span class="z-text z-plain">  Recheck Cond: (((payload -> 'user'::text) ->> 'name'::text) = 'abcedefgh'::text)
</span><span class="z-text z-plain">  ->  Bitmap Index Scan on index_events_jsonbs_on_payload_user_name  (cost=0.00..16.17 rows=500 width=0)
</span><span class="z-text z-plain">        Index Cond: (((payload -> 'user'::text) ->> 'name'::text) = 'abcedefgh'::text)
</span></code></pre><p>Porém, se você prestar atenção, criamos o índice com o último atributo do caminho como texto <code>->></code>, isto quer dizer que o índice foi criado levando isso em consideração, se tentarmos buscar com o operador que retorna JSON/JSONB (<code>-></code>), o índice não será utilizado:<pre class=z-code><code><span class="z-text z-plain"># EXPLAIN SELECT * FROM events_jsonbs WHERE payload->'user'->'name' = to_jsonb('abcedefgh'::text)
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">Seq Scan on events_jsonbs  (cost=0.00..3271.00 rows=500 width=71)
</span><span class="z-text z-plain">  Filter: (((payload -> 'user'::text) -> 'name'::text) = to_jsonb('abcedefgh'::text))
</span></code></pre><h3 id=comparando-resultados>Comparando resultados<a aria-label="Anchor link for: comparando-resultados" class=zola-anchor href=#comparando-resultados style=visibility:hidden>#</a></h3><p>Ao rodar o <em>benchmark</em> novamente com 1.000 iterações, obtivemos o seguinte resultado:<pre class=z-code><code><span class="z-text z-plain">Rehearsal -----------------------------------------------------------------
</span><span class="z-text z-plain">json                            0.227027   0.121803   0.348830 ( 65.469822)
</span><span class="z-text z-plain">jsonb b-tree expression index   0.071625   0.018892   0.090517 (  0.198652)
</span><span class="z-text z-plain">jsonb gin index                 0.062371   0.025346   0.087717 (  0.226455)
</span><span class="z-text z-plain">-------------------------------------------------------- total: 0.527064sec
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">                                    user     system      total        real
</span><span class="z-text z-plain">json                            0.286155   0.062060   0.348215 ( 65.596319)
</span><span class="z-text z-plain">jsonb b-tree expression index   0.053768   0.026578   0.080346 (  0.182883)
</span><span class="z-text z-plain">jsonb gin index                 0.041516   0.043382   0.084898 (  0.222005)
</span></code></pre><p>Notamos que em ambos os casos onde o índice foi aplicado houve redução de quase 99% do tempo se comparado ao campo JSONB sem índice (<em>benchmark</em> anterior).<h2 id=conclusao>Conclusão<a aria-label="Anchor link for: conclusao" class=zola-anchor href=#conclusao style=visibility:hidden>#</a></h2><p>O uso do campo JSONB no Rails, apesar do suporte, só revela seu total poder se utilizado em conjunto com as funções e operadores nativos do Postgres, com um ponto de atenção especial ao comportamento dos diferentes tipos de índices em um campo JSONB.</article><div class=giscus></div></div><footer><div class=copyright><p>© 2024 José Venâncio</div><div class=credits>powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>